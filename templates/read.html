<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>错误日志查看器</title>
  <script src="/static/css/tailwindcss.css"></script>
  <style>
    /* 防止换行并截断文本 */
    .truncate-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 250px;
      cursor: pointer;
    }

    /* 弹窗遮罩 */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    /* 弹窗内容 */
    #modalContent {
      background: white;
      border-radius: 0.75rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f9fafb;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-7xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-semibold mb-6 text-center text-gray-700">🧾 错误日志查看器</h1>

    <!-- 搜索框 -->
    <form method="GET" action="/read" class="flex items-center justify-center gap-3 mb-6">
      <input
        type="date"
        name="date"
        value="{{.Date}}"
        class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        type="submit"
        class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition"
      >
        搜索
      </button>
      <button
        type="button" onclick="viewDeepSeekEdit()"
        class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition"
      >
        配置 DeepSeek API Key
      </button>
    </form>

    <!-- 日志表格 -->
    {{if .LogEntries}}
    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
      <table class="min-w-full table-fixed divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="w-40 px-4 py-2 text-left text-sm font-semibold text-gray-600">时间</th>
            <th class="w-40 px-4 py-2 text-left text-sm font-semibold text-gray-600">项目</th>
            <th class="w-28 px-4 py-2 text-left text-sm font-semibold text-gray-600">等级</th>
            <th class="w-96 px-4 py-2 text-left text-sm font-semibold text-gray-600">信息</th>
            <th class="w-96 px-4 py-2 text-left text-sm font-semibold text-gray-600">文件</th>
            <th class="w-64 px-4 py-2 text-left text-sm font-semibold text-gray-600">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {{range $index, $entry := .LogEntries}}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Timestamp}}">{{.Timestamp}}</td>
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Project}}">{{.Project}}</td>
            <td class="px-4 py-2 text-sm">
              <span class="px-2 py-1 text-xs rounded-full 
                {{if eq .Level "error"}}bg-red-100 text-red-700
                {{else if eq .Level "warning"}}bg-yellow-100 text-yellow-700
                {{else}}bg-green-100 text-green-700{{end}}">
                {{.Level}}
              </span>
            </td>
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Message}}">{{.Message}}</td>
            <td class="px-4 py-2 text-sm text-gray-500 truncate-cell" title="{{.File}}:{{.Line}}">{{.File}}:{{.Line}}</td>
            <td class="px-4 py-2 text-sm text-gray-500 truncate-cell">
              <button onclick="viewDetails(this)" data-index="{{$index}}" class="text-blue-600 hover:underline text-sm">查看</button>
              <button onclick="deleteLine(this)" data-uuid="{{.UUID}}" class="text-red-600 hover:underline text-sm ml-3">删除</button>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="text-center text-gray-500 mt-10">暂无日志记录</div>
    {{end}}

    <!-- 分页 -->
    <div class="flex justify-center items-center gap-4 mt-8">
      {{if gt .Page 1}}
      <a href="/read?date={{.Date}}&page={{sub .Page 1}}" 
        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">上一页</a>
      {{end}}
      <span class="text-gray-600 text-sm">第 {{.Page}} 页</span>
      {{if .HasNext}}
      <a href="/read?date={{.Date}}&page={{add .Page 1}}" 
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">下一页</a>
      {{end}}
    </div>
  </div>

  <!-- 弹窗 -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" onclick="closeModal()">
        <div class="bg-white max-w-3xl w-full p-6 rounded-lg shadow-lg relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <h2 class="text-xl font-semibold mb-3">
                AI解读
                <button
                    type="button"
                    class="bg-green-600 text-white px-2 py-1 text-sm float-right rounded-lg hover:bg-green-700 transition"
                    onclick="chatStream()"
                >
                    立即分析
                </button>
            </h2>
            <pre id="chatStreamText" class="text-xs whitespace-pre-wrap break-words"></pre>
            <div class="bg-white w-full p-6 ">
            </div>
            <h2 class="text-xl font-semibold mb-3">日志详情</h2>
            <div id="contentWrapper" class="relative overflow-hidden transition-all duration-300 flex-1">
            <pre id="modalText" class="text-xs whitespace-pre-wrap break-words"></pre>
            <div id="fadeOverlay" class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
            </div>
            <div class="flex justify-between items-center mt-3">
                <button id="toggleBtn" class="text-blue-600 hover:underline text-sm">展开更多</button>
            </div>
        </div>
    </div>
    <div id="modalApiKeyEdit" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" onclick="closeApiKeyModal()">
        <div class="bg-white max-w-3xl w-full p-6 rounded-lg shadow-lg relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <h2 class="text-xl font-semibold mb-3">配置 API KEY</h2>
            <div class="flex">
                <input
                    type="text"
                    id="apiKeyInput"
                    value=""
                    class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 flex-1"
                />
                <button
                    type="button"
                    class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition w-32"
                    onclick="saveApiKey()"
                >
                    保存
                </button>
            </div>
        </div>
    </div>
</div>
<script id="log-data" type="application/json">
{{ toJson .LogEntries }}
</script>
<script>
  const dataElem = document.getElementById('log-data');
  const modalOverlay = document.getElementById('modalOverlay');
  const contentWrapper = document.getElementById('contentWrapper');
  const fadeOverlay = document.getElementById('fadeOverlay');
  const toggleBtn = document.getElementById('toggleBtn');
  const modalText = document.getElementById('modalText');
  const modalApiKeyEdit = document.getElementById('modalApiKeyEdit');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const chatStreamText = document.getElementById('chatStreamText');
  const apiKey = '';

  let logEntries = [];
  try {
    logEntries = JSON.parse(dataElem.textContent || '[]');
  } catch (e) {
    console.error('解析日志数据失败', e);
    logEntries = [];
  }

  function viewDeepSeekEdit() {
    fetch(`/apikey`, { method: "GET" }).then(res => res.json()).then(data => {
        console.log(data)
        modalApiKeyEdit.style.display = 'flex';
        apiKeyInput.value = data.api_key || '';
    }).catch(err => {
        console.error('获取 API Key 失败', err)
        alert('获取 API Key 失败');
    });
  }

  function saveApiKey(){
        const newApiKey = apiKeyInput.value.trim();
        fetch("/apikey", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ api_key: newApiKey })
        }).then(res => res.json()).then(data => {
            alert('保存成功');
            closeApiKeyModal();
        }).catch(err => {
            console.error('保存 API Key 失败', err)
            alert('保存 API Key 失败');
        })
  }

  function closeApiKeyModal() {
        modalApiKeyEdit.style.display = 'none';
  }

  function viewDetails(data) {
    const index = parseInt(data.dataset.index, 10);
    const entry = logEntries[index];
    modalText.textContent = JSON.stringify(entry, null, 2);
    contentWrapper.classList.add('max-h-20');
    contentWrapper.style.overflowY = 'hidden';
    fadeOverlay.style.display = 'block';
    toggleBtn.textContent = '展开更多';
    modalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  toggleBtn.addEventListener('click', () => {
    if (contentWrapper.classList.contains('max-h-20')) {
      // 展开
      contentWrapper.classList.remove('max-h-20');
      contentWrapper.style.overflowY = 'auto';
      fadeOverlay.style.display = 'none';
      toggleBtn.textContent = '收起';
    } else {
      // 收起
      contentWrapper.classList.add('max-h-20');
      contentWrapper.style.overflowY = 'hidden';
      fadeOverlay.style.display = 'block';
      toggleBtn.textContent = '展开更多';
    }
  });

  async function chatStream(){
    const obj = JSON.parse(modalText.textContent)
    delete obj.context
    delete obj.server
    const entry = JSON.stringify(obj)
    const prompt = `你将收到一个PHP项目的错误信息(JSON格式)，请你只根据错误内容简洁分析以下两点：
1. 这是什么问题（说明错误原因）
2. 我应该关注哪些地方来修复这个问题（指出关键文件、行号、可能出错的逻辑）

要求：
- 不要输出任何无意义的开头或总结
- 不要使用markdown语法或多余格式
- 直接以纯文本方式输出，适合放在<pre>标签内展示
- 保持逻辑清晰，段落分明

下面是错误信息：${entry}`
    const response = await fetch("/chat-stream", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "deepseek-chat",
            messages: [
            { role: "user", content: prompt }
            ]
        })
    });
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let result = "";
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        result += decoder.decode(value, { stream: true });
        // 你可以在这里实时更新前端显示
        chatStreamText.textContent = result;
    }
  }

  function deleteLine(data) {
    let dateInput = document.querySelector('input[type="date"]');
    let dateValue = dateInput.value;
    let url = `/delete?uuid=${data.dataset.uuid}`;
    if (dateValue) {
      url += `&date=${dateValue}`;
    }
    fetch(url, { method: "DELETE" })
      .then((response) => response.json())
      .then(() => location.reload())
      .catch((error) => console.error("删除失败:", error));
  }
</script>

</body>
</html>
