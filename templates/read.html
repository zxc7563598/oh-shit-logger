<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>é”™è¯¯æ—¥å¿—æŸ¥çœ‹å™¨</title>
  <script src="/static/css/tailwindcss.css"></script>
  <style>
    /* é˜²æ­¢æ¢è¡Œå¹¶æˆªæ–­æ–‡æœ¬ */
    .truncate-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 250px;
      cursor: pointer;
    }

    /* å¼¹çª—é®ç½© */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    /* å¼¹çª—å†…å®¹ */
    #modalContent {
      background: white;
      border-radius: 0.75rem;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f9fafb;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-7xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-semibold mb-6 text-center text-gray-700">ğŸ§¾ é”™è¯¯æ—¥å¿—æŸ¥çœ‹å™¨</h1>

    <!-- æœç´¢æ¡† -->
    <form method="GET" action="/read" class="flex items-center justify-center gap-3 mb-6">
      <input
        type="date"
        name="date"
        value="{{.Date}}"
        class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        type="submit"
        class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition"
      >
        æœç´¢
      </button>
      <button
        type="button" onclick="viewDeepSeekEdit()"
        class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition"
      >
        é…ç½® DeepSeek API Key
      </button>
    </form>

    <!-- æ—¥å¿—è¡¨æ ¼ -->
    {{if .LogEntries}}
    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
      <table class="min-w-full table-fixed divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="w-40 px-4 py-2 text-left text-sm font-semibold text-gray-600">æ—¶é—´</th>
            <th class="w-40 px-4 py-2 text-left text-sm font-semibold text-gray-600">é¡¹ç›®</th>
            <th class="w-28 px-4 py-2 text-left text-sm font-semibold text-gray-600">ç­‰çº§</th>
            <th class="w-96 px-4 py-2 text-left text-sm font-semibold text-gray-600">ä¿¡æ¯</th>
            <th class="w-96 px-4 py-2 text-left text-sm font-semibold text-gray-600">æ–‡ä»¶</th>
            <th class="w-64 px-4 py-2 text-left text-sm font-semibold text-gray-600">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {{range $index, $entry := .LogEntries}}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Timestamp}}">{{.Timestamp}}</td>
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Project}}">{{.Project}}</td>
            <td class="px-4 py-2 text-sm">
              <span class="px-2 py-1 text-xs rounded-full 
                {{if eq .Level "error"}}bg-red-100 text-red-700
                {{else if eq .Level "warning"}}bg-yellow-100 text-yellow-700
                {{else}}bg-green-100 text-green-700{{end}}">
                {{.Level}}
              </span>
            </td>
            <td class="px-4 py-2 text-sm text-gray-700 truncate-cell" title="{{.Message}}">{{.Message}}</td>
            <td class="px-4 py-2 text-sm text-gray-500 truncate-cell" title="{{.File}}:{{.Line}}">{{.File}}:{{.Line}}</td>
            <td class="px-4 py-2 text-sm text-gray-500 truncate-cell">
              <button onclick="viewDetails(this)" data-index="{{$index}}" class="text-blue-600 hover:underline text-sm">æŸ¥çœ‹</button>
              <button onclick="deleteLine(this)" data-uuid="{{.UUID}}" class="text-red-600 hover:underline text-sm ml-3">åˆ é™¤</button>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="text-center text-gray-500 mt-10">æš‚æ— æ—¥å¿—è®°å½•</div>
    {{end}}

    <!-- åˆ†é¡µ -->
    <div class="flex justify-center items-center gap-4 mt-8">
      {{if gt .Page 1}}
      <a href="/read?date={{.Date}}&page={{sub .Page 1}}" 
        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">ä¸Šä¸€é¡µ</a>
      {{end}}
      <span class="text-gray-600 text-sm">ç¬¬ {{.Page}} é¡µ</span>
      {{if .HasNext}}
      <a href="/read?date={{.Date}}&page={{add .Page 1}}" 
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">ä¸‹ä¸€é¡µ</a>
      {{end}}
    </div>
  </div>

  <!-- å¼¹çª— -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" onclick="closeModal()">
        <div class="bg-white max-w-3xl w-full p-6 rounded-lg shadow-lg relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <h2 class="text-xl font-semibold mb-3">
                AIè§£è¯»
                <button
                    type="button"
                    class="bg-green-600 text-white px-2 py-1 text-sm float-right rounded-lg hover:bg-green-700 transition"
                    onclick="chatStream()"
                >
                    ç«‹å³åˆ†æ
                </button>
            </h2>
            <pre id="chatStreamText" class="text-xs whitespace-pre-wrap break-words"></pre>
            <div class="bg-white w-full p-6 ">
            </div>
            <h2 class="text-xl font-semibold mb-3">æ—¥å¿—è¯¦æƒ…</h2>
            <div id="contentWrapper" class="relative overflow-hidden transition-all duration-300 flex-1">
            <pre id="modalText" class="text-xs whitespace-pre-wrap break-words"></pre>
            <div id="fadeOverlay" class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
            </div>
            <div class="flex justify-between items-center mt-3">
                <button id="toggleBtn" class="text-blue-600 hover:underline text-sm">å±•å¼€æ›´å¤š</button>
            </div>
        </div>
    </div>
    <div id="modalApiKeyEdit" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" onclick="closeApiKeyModal()">
        <div class="bg-white max-w-3xl w-full p-6 rounded-lg shadow-lg relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <h2 class="text-xl font-semibold mb-3">é…ç½® API KEY</h2>
            <div class="flex">
                <input
                    type="text"
                    id="apiKeyInput"
                    value=""
                    class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 flex-1"
                />
                <button
                    type="button"
                    class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition w-32"
                    onclick="saveApiKey()"
                >
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>
<script id="log-data" type="application/json">
{{ toJson .LogEntries }}
</script>
<script>
  const dataElem = document.getElementById('log-data');
  const modalOverlay = document.getElementById('modalOverlay');
  const contentWrapper = document.getElementById('contentWrapper');
  const fadeOverlay = document.getElementById('fadeOverlay');
  const toggleBtn = document.getElementById('toggleBtn');
  const modalText = document.getElementById('modalText');
  const modalApiKeyEdit = document.getElementById('modalApiKeyEdit');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const chatStreamText = document.getElementById('chatStreamText');
  const apiKey = '';

  let logEntries = [];
  try {
    logEntries = JSON.parse(dataElem.textContent || '[]');
  } catch (e) {
    console.error('è§£ææ—¥å¿—æ•°æ®å¤±è´¥', e);
    logEntries = [];
  }

  function viewDeepSeekEdit() {
    fetch(`/apikey`, { method: "GET" }).then(res => res.json()).then(data => {
        console.log(data)
        modalApiKeyEdit.style.display = 'flex';
        apiKeyInput.value = data.api_key || '';
    }).catch(err => {
        console.error('è·å– API Key å¤±è´¥', err)
        alert('è·å– API Key å¤±è´¥');
    });
  }

  function saveApiKey(){
        const newApiKey = apiKeyInput.value.trim();
        fetch("/apikey", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ api_key: newApiKey })
        }).then(res => res.json()).then(data => {
            alert('ä¿å­˜æˆåŠŸ');
            closeApiKeyModal();
        }).catch(err => {
            console.error('ä¿å­˜ API Key å¤±è´¥', err)
            alert('ä¿å­˜ API Key å¤±è´¥');
        })
  }

  function closeApiKeyModal() {
        modalApiKeyEdit.style.display = 'none';
  }

  function viewDetails(data) {
    const index = parseInt(data.dataset.index, 10);
    const entry = logEntries[index];
    modalText.textContent = JSON.stringify(entry, null, 2);
    contentWrapper.classList.add('max-h-20');
    contentWrapper.style.overflowY = 'hidden';
    fadeOverlay.style.display = 'block';
    toggleBtn.textContent = 'å±•å¼€æ›´å¤š';
    modalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  toggleBtn.addEventListener('click', () => {
    if (contentWrapper.classList.contains('max-h-20')) {
      // å±•å¼€
      contentWrapper.classList.remove('max-h-20');
      contentWrapper.style.overflowY = 'auto';
      fadeOverlay.style.display = 'none';
      toggleBtn.textContent = 'æ”¶èµ·';
    } else {
      // æ”¶èµ·
      contentWrapper.classList.add('max-h-20');
      contentWrapper.style.overflowY = 'hidden';
      fadeOverlay.style.display = 'block';
      toggleBtn.textContent = 'å±•å¼€æ›´å¤š';
    }
  });

  async function chatStream(){
    const obj = JSON.parse(modalText.textContent)
    delete obj.context
    delete obj.server
    const entry = JSON.stringify(obj)
    const prompt = `ä½ å°†æ”¶åˆ°ä¸€ä¸ªPHPé¡¹ç›®çš„é”™è¯¯ä¿¡æ¯(JSONæ ¼å¼)ï¼Œè¯·ä½ åªæ ¹æ®é”™è¯¯å†…å®¹ç®€æ´åˆ†æä»¥ä¸‹ä¸¤ç‚¹ï¼š
1. è¿™æ˜¯ä»€ä¹ˆé—®é¢˜ï¼ˆè¯´æ˜é”™è¯¯åŸå› ï¼‰
2. æˆ‘åº”è¯¥å…³æ³¨å“ªäº›åœ°æ–¹æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼ˆæŒ‡å‡ºå…³é”®æ–‡ä»¶ã€è¡Œå·ã€å¯èƒ½å‡ºé”™çš„é€»è¾‘ï¼‰

è¦æ±‚ï¼š
- ä¸è¦è¾“å‡ºä»»ä½•æ— æ„ä¹‰çš„å¼€å¤´æˆ–æ€»ç»“
- ä¸è¦ä½¿ç”¨markdownè¯­æ³•æˆ–å¤šä½™æ ¼å¼
- ç›´æ¥ä»¥çº¯æ–‡æœ¬æ–¹å¼è¾“å‡ºï¼Œé€‚åˆæ”¾åœ¨<pre>æ ‡ç­¾å†…å±•ç¤º
- ä¿æŒé€»è¾‘æ¸…æ™°ï¼Œæ®µè½åˆ†æ˜

ä¸‹é¢æ˜¯é”™è¯¯ä¿¡æ¯ï¼š${entry}`
    const response = await fetch("/chat-stream", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "deepseek-chat",
            messages: [
            { role: "user", content: prompt }
            ]
        })
    });
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let result = "";
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        result += decoder.decode(value, { stream: true });
        // ä½ å¯ä»¥åœ¨è¿™é‡Œå®æ—¶æ›´æ–°å‰ç«¯æ˜¾ç¤º
        chatStreamText.textContent = result;
    }
  }

  function deleteLine(data) {
    let dateInput = document.querySelector('input[type="date"]');
    let dateValue = dateInput.value;
    let url = `/delete?uuid=${data.dataset.uuid}`;
    if (dateValue) {
      url += `&date=${dateValue}`;
    }
    fetch(url, { method: "DELETE" })
      .then((response) => response.json())
      .then(() => location.reload())
      .catch((error) => console.error("åˆ é™¤å¤±è´¥:", error));
  }
</script>

</body>
</html>
